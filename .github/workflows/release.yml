name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    concurrency: release

    outputs:
      released: ${{ steps.release.outputs.released }}
      version: ${{ steps.release.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.14

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Python Semantic Release
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          uv run semantic-release version --print
          uv run semantic-release version
          echo "version=$(uv run semantic-release version --print-last-released)" >> $GITHUB_OUTPUT
          echo "released=$(if git tag --points-at HEAD | grep -q '^v'; then echo true; else echo false; fi)" >> $GITHUB_OUTPUT

      - name: Publish to GitHub Releases
        if: steps.release.outputs.released == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: uv run semantic-release publish

  container:
    name: Build and Push Container
    runs-on: ubuntu-latest
    needs: release
    if: needs.release.outputs.released == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: v${{ needs.release.outputs.version }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # =======================================================================
      # Container Registry Authentication
      # =======================================================================
      # This workflow uses GitHub Container Registry (ghcr.io).
      # The GITHUB_TOKEN is automatically provided and has the necessary
      # permissions to push to ghcr.io for repositories in your account.
      #
      # No additional secrets are required for ghcr.io authentication.
      # The 'packages: write' permission at the top of this file enables this.
      #
      # For other registries (Docker Hub, AWS ECR, etc.), you would need to:
      # 1. Create appropriate secrets in your repository settings
      # 2. Update the login step below with those credentials
      # =======================================================================

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}},value=v${{ needs.release.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=v${{ needs.release.outputs.version }}
            type=semver,pattern={{major}},value=v${{ needs.release.outputs.version }}
            type=raw,value=latest

      - name: Build and push container image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Containerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: release
    if: needs.release.outputs.released == 'true'
    environment:
      name: pypi
      url: https://pypi.org/p/python-template

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: v${{ needs.release.outputs.version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.14

      - name: Build package
        run: uv build

      # =======================================================================
      # PyPI Publishing Authentication
      # =======================================================================
      # This uses PyPI's Trusted Publisher feature with OIDC (OpenID Connect).
      # No API tokens or passwords are stored as secrets.
      #
      # Setup steps:
      # 1. Go to https://pypi.org/manage/account/publishing/
      # 2. Add a new "pending publisher" with:
      #    - PyPI Project Name: python-template (or your package name)
      #    - Owner: nahuel11500 (your GitHub username/org)
      #    - Repository: python-template-project
      #    - Workflow name: release.yml
      #    - Environment name: pypi
      # 3. The first publish will claim the project name
      #
      # The 'id-token: write' permission at the top enables OIDC authentication.
      # =======================================================================

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        # No credentials needed - uses OIDC trusted publishing
